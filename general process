# 1. Install required library
!pip install simpy -q

import simpy
import random
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# --- SIMULATION CONFIGURATION ---
RANDOM_SEED = 42
SIM_TIME = 1440       # Total simulation time (1 day in minutes)
NUM_GATES = 21        # Fixed resource constraint to demonstrate stress conditions
SCENARIOS = {
    'Baseline (0%)': 1.0,
    'ITS Level 1 (10%)': 0.9,
    'ITS Level 2 (20%)': 0.8,
    'ITS Level 3 (25%)': 0.75
}

# Average daily arrivals based on Eurocontrol 2025 data
AIRPORTS = {
    'Frankfurt (EDDF)': 637,
    'London Heathrow (EGLL)': 658,
    'Paris CDG (LFPG)': 659
}

# --- SIMULATION LOGIC ---
class AirportTerminal:
    def __init__(self, env, num_gates):
        self.env = env
        self.gates = simpy.Resource(env, num_gates)

def turnaround_process(env, efficiency_coeff):
    """Simulates aircraft ground handling with efficiency optimization."""
    # Base service time between 30 and 60 minutes
    duration = random.uniform(30, 60) * efficiency_coeff
    yield env.timeout(duration)

def flight_entity(env, terminal, efficiency_coeff, results):
    """Represents a single flight requesting a gate."""
    arrival_time = env.now
    with terminal.gates.request() as request:
        yield request
        wait_time = env.now - arrival_time
        results.append(wait_time)
        yield env.process(turnaround_process(env, efficiency_coeff))

def traffic_generator(env, num_arrivals, terminal, efficiency_coeff, results):
    """Generates incoming traffic based on Eurocontrol frequency."""
    inter_arrival_time = SIM_TIME / num_arrivals
    while True:
        # Stochastic inter-arrival using exponential distribution (G/G/k logic)
        yield env.timeout(random.expovariate(1.0 / inter_arrival_time))
        env.process(flight_entity(env, terminal, efficiency_coeff, results))

def run_airport_simulation(num_arrivals, efficiency_coeff):
    """Executes a single simulation run for a specific scenario."""
    random.seed(RANDOM_SEED)
    env = simpy.Environment()
    terminal = AirportTerminal(env, NUM_GATES)
    results = []
    env.process(traffic_generator(env, num_arrivals, terminal, efficiency_coeff, results))
    env.run(until=SIM_TIME)
    return results

# --- DATA COLLECTION ---
print("ðŸš€ Running simulations for European Hubs...")
all_wait_times = []
summary_data = []

for apt_name, arrivals in AIRPORTS.items():
    for sc_name, coeff in SCENARIOS.items():
        waits = run_airport_simulation(arrivals, coeff)
        summary_data.append({
            'Airport': apt_name,
            'Scenario': sc_name,
            'Average Wait': np.mean(waits)
        })
        for w in waits:
            all_wait_times.append({'Airport': apt_name, 'Scenario': sc_name, 'WaitTime': w})

df_summary = pd.DataFrame(summary_data)
df_all = pd.DataFrame(all_wait_times)

# --- VISUALIZATION 1: AVERAGE WAITING TIME (BAR CHART) ---
plt.style.use('seaborn-v0_8-whitegrid')
plt.figure(figsize=(12, 6))
sns.barplot(data=df_summary, x='Airport', y='Average Wait', hue='Scenario', palette='viridis')

plt.title('Impact of ITS Implementation on Average Gate Waiting Times', fontsize=14, fontweight='bold')
plt.ylabel('Mean Waiting Time (minutes)', fontsize=12)
plt.xlabel('European Aviation Hubs (Eurocontrol 2025 Data)', fontsize=12)
plt.legend(title='Digitalization Scenarios')
plt.grid(axis='y', linestyle='--', alpha=0.7)

# Adding data labels on top of bars
for p in plt.gca().patches:
    if p.get_height() > 0:
        plt.gca().annotate(f'{p.get_height():.2f}', (p.get_x() + p.get_width() / 2., p.get_height()), 
                    ha='center', va='center', xytext=(0, 9), textcoords='offset points', fontsize=9)

plt.tight_layout()
plt.savefig('average_wait_times.png', dpi=300)
plt.show()

# --- VISUALIZATION 2: DELAY DISTRIBUTION (KDE PLOTS) ---
fig, axes = plt.subplots(1, 3, figsize=(20, 6), sharey=True)
colors = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71']

for i, apt_name in enumerate(AIRPORTS.keys()):
    ax = axes[i]
    for j, sc_name in enumerate(SCENARIOS.keys()):
        subset = df_all[(df_all['Airport'] == apt_name) & (df_all['Scenario'] == sc_name)]
        sns.kdeplot(subset['WaitTime'], ax=ax, label=sc_name, color=colors[j], fill=True, alpha=0.1)
    
    ax.set_title(f'Delay Distribution: {apt_name}', fontsize=14, fontweight='bold')
    ax.set_xlabel('Queue Waiting Time (min)', fontsize=11)
    ax.set_xlim(0, 35)
    ax.legend(fontsize=9)
    ax.grid(True, alpha=0.3)

plt.suptitle('Comparative Analysis of Arrival Stochasticity and Digital Twin Stability', fontsize=16, y=1.02)
plt.tight_layout()
plt.savefig('delay_distributions.png', dpi=300)
plt.show()

print("\nâœ… Simulation completed. Figures 'average_wait_times.png' and 'delay_distributions.png' generated.")
